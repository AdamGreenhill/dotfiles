#!/bin/bash
# Bash wrappers for docker run commands


#
# Helper Functions
#
dcleanup(){
	sudo docker rm -v $(docker ps --filter status=exited -q 2>/dev/null) 2>/dev/null
	sudo docker rmi $(docker images --filter dangling=true -q 2>/dev/null) 2>/dev/null
}

drunning(){
	processes=`ps aux`

	if [[ $processes != *"docker daemon"* ]]
	then
		sudo docker daemon &
	fi
}

dbuild(){

	drunning
	sudo docker build `pwd`

}

dsetup_device() {
	if [ ! -c "$1" ]; then
		sudo mknod $1 c 81 0
		sudo chmod 666 $1
	fi
}

dsetup_display() {

	DISPLAY=:0.0; export DISPLAY;
	xhost +localhost;

}

del_stopped(){
	local name=$1
	local state=$(docker inspect --format "{{.State.Running}}" $name 2>/dev/null)

	if [[ "$state" == "false" ]]; then
		docker rm $name
	fi
}

django_bootstrap(){
	drunning
	sudo docker run -it --rm -v "$PWD":/usr/src/app -w /usr/src/app django django-admin.py startproject $1;
}

django_debug(){
	drunning
	sudo docker run -it -v "$PWD":/usr/src/app -w /usr/src/app -p 8000:8000 django bash
}

django_server(){
	drunning
	sudo docker run -v "$PWD":/usr/src/app -w /usr/src/app -p 8000:8000 -d django bash -c "pip install -r requirements.txt && python manage.py runserver 0.0.0.0:8000"
}

relies_on(){
	local containers=$@

	for container in $containers; do
		local state=$(docker inspect --format "{{.State.Running}}" $container 2>/dev/null)

		if [[ "$state" == "false" ]] || [[ "$state" == "" ]]; then
			echo "$container is not running, starting it for you."
			$container
		fi
	done
}
# creates an nginx config for a local route
nginx_config(){
	server=$1
	route=$2

	cat >${HOME}/.nginx/conf.d/${server}.conf <<-EOF
	upstream ${server} { server ${route}; }
	server {
	server_name ${server};

	location / {
	proxy_pass  http://${server};
	proxy_http_version 1.1;
	proxy_set_header Upgrade \$http_upgrade;
	proxy_set_header Connection "upgrade";
	proxy_set_header Host \$http_host;
	proxy_set_header X-Forwarded-Proto \$scheme;
	proxy_set_header X-Forwarded-For \$remote_addr;
	proxy_set_header X-Forwarded-Port \$server_port;
	proxy_set_header X-Request-Start \$msec;
}
	}
	EOF

	# restart nginx
	docker restart nginx

	# add host to /etc/hosts
	sudo hostess add $server 127.0.0.1

	# open browser
	browser-exec "http://${server}"
}

#
# Container Aliases
#
aptfile_docker(){
	docker run --rm -it \
		--name apt-file \
		jess/apt-file
}
alias apt-file="apt_file"
aws_docker(){
	docker run -it --rm \
		-v $HOME/.aws:/root/.aws \
		--log-driver none \
		--name aws \
		jess/awscli "$@"
}

# AWS DOS
bees_docker(){
	docker run -it --rm \
		-e NOTARY_TOKEN \
		-v $HOME/.bees:/root/.bees \
		-v $HOME/.boto:/root/.boto \
		-v $HOME/.dev:/root/.ssh:ro \
		--log-driver none \
		--name bees \
		jess/beeswithmachineguns "$@"
}
chrome_docker(){
	# add flags for proxy if passed
	local proxy=
	local map=
	local args=$@
	if [[ "$1" == "tor" ]]; then
		relies_on torproxy

		map="MAP * ~NOTFOUND , EXCLUDE torproxy"
		proxy="socks5://torproxy:9050"
		args="https://check.torproject.org/api/ip ${@:2}"
	fi

	drunning
	del_stopped chrome
	dsetup_display
	dsetup_device /dev/snd
	dsetup_device /dev/dri
	dsetup_device /dev/video0
	dsetup_device /dev/usb

	# one day remove /etc/hosts bind mount when effing
	# overlay support inotify, such bullshit
	docker run -d \
		--memory 3gb \
		--net host \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-v $HOME/Downloads:/root/Downloads \
		-v $HOME/Pictures:/root/Pictures \
		-v $HOME/Torrents:/root/Torrents \
		-v $HOME/.chrome:/data \
		-v /dev/shm:/dev/shm \
		-v /etc/hosts:/etc/hosts \
		--device /dev/snd \
		--device /dev/dri \
		--device /dev/video0 \
		--device /dev/usb \
		--device /dev/bus/usb \
		--group-add audio \
		--group-add video \
		--name chrome \
		jess/chrome --user-data-dir=/data --force-device-scale-factor=1 \
		--proxy-server="$proxy" --host-resolver-rules="$map" "$args"

}
# Tool for service discovery and configuration
consul_docker(){
	del_stopped consul

	# check if we passed args and if consul is running
	local args=$@
	local state=$(docker inspect --format "{{.State.Running}}" consul 2>/dev/null)
	if [[ "$state" == "true" ]] && [[ ! -z "$args" ]]; then
		docker exec -it consul consul "$@"
		return 0
	fi

	docker run -d \
		--restart always \
		-v $HOME/.consul:/etc/consul.d \
		-v /var/run/docker.sock:/var/run/docker.sock \
		--net host \
		-e GOMAXPROCS=2 \
		--name consul \
		jess/consul agent \
		-bootstrap-expect 1 \
		-config-dir /etc/consul.d \
		-data-dir /data \
		-encrypt $(docker run --rm jess/consul keygen) \
		-ui-dir /usr/src/consul \
		-server \
		-dc neverland \
		-bind 0.0.0.0

	sudo hostess add consul $(docker inspect --format "{{.NetworkSettings.Networks.bridge.IPAddress}}" consul)
	browser-exec "http://consul:8500"
}
firefox_docker(){

	drunning
	del_stopped firefox

	dsetup_display
	dsetup_device /dev/snd
	dsetup_device /dev/dri

	docker run -d \
		--memory 2gb \
		--net host \
		--cpuset-cpus 0 \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v $HOME/.firefox/cache:/root/.cache/mozilla \
		-v $HOME/.firefox/mozilla:/root/.mozilla \
		-v $HOME/Downloads:/root/Downloads \
		-v $HOME/Pictures:/root/Pictures \
		-v $HOME/Torrents:/root/Torrents \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--device /dev/snd \
		--device /dev/dri \
		--name firefox \
		jess/firefox "$@"

	# exit current shell
	exit 0
}
# google calendar cli
gcalcli_docker(){
	docker run --rm -it \
		-v /etc/localtime:/etc/localtime:ro \
		-v $HOME/.gcalcli/home:/home/gcalcli/home \
		-v $HOME/.gcalcli/work/oauth:/home/gcalcli/.gcalcli_oauth \
		-v $HOME/.gcalcli/work/gcalclirc:/home/gcalcli/.gcalclirc \
		--name gcalcli \
		jess/gcalcli "$@"
}
# image manipulation tool
gimp_docker(){
	drunning
	del_stopped gimp

	dsetup_display

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-v $HOME/Pictures:/root/Pictures \
		-v $HOME/.gtkrc:/root/.gtkrc \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--name gimp \
		jess/gimp
}
# hacker typing ++
hollywood_docker(){
	docker run --rm -it \
		--name hollywood \
		jess/hollywood
}

htop_docker(){
	docker run --rm -it \
		--pid host \
		--name htop \
		jess/htop
}

libreoffice_docker(){

	drunning

	del_stopped libreoffice

	dsetup_display

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-v $HOME/slides:/root/slides \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--name libreoffice \
		jess/libreoffice
}

# terminal audio player with ncp
mpd_docker(){
	del_stopped mpd

	# adding cap sys_admin so I can use nfs mount
	# the container runs as a unpriviledged user mpd
	docker run -d \
		--device /dev/snd \
		--cap-add SYS_ADMIN \
		-e MPD_HOST=/var/lib/mpd/socket \
		-v /etc/localtime:/etc/localtime:ro \
		-v /etc/exports:/etc/exports:ro \
		-v $HOME/.mpd:/var/lib/mpd \
		-v $HOME/.mpd.conf:/etc/mpd.conf \
		--name mpd \
		jess/mpd
}
mutt_docker(){
	# subshell so we dont overwrite variables
	(
	local account=$1
	export IMAP_SERVER=""
	export SMTP_SERVER=""

	if [[ "$account" == "docker" ]]; then
		GMAIL=$GMAIL_DOCKER
		GMAIL_NAME=$GMAIL_DOCKER_NAME
		GMAIL_PASS=$GMAIL_DOCKER_PASS
		GMAIL_FROM=$GMAIL_DOCKER_FROM
	elif [[ "$account" == "riseup" ]]; then
		GMAIL=$MAIL_RISEUP
		GMAIL_NAME=$MAIL_RISEUP_NAME
		GMAIL_PASS=$MAIL_RISEUP_PASS
		GMAIL_FROM=$MAIL_RISEUP_FROM
		IMAP_SERVER=mail.riseup.net
		SMTP_SERVER=$IMAP_SERVER
	fi

	docker run -it --rm \
		-e GMAIL \
		-e GMAIL_NAME \
		-e GMAIL_PASS \
		-e GMAIL_FROM \
		-e GPG_ID \
		-e IMAP_SERVER \
		-e SMTP_SERVER \
		-v $HOME/.gnupg:/home/user/.gnupg \
		-v /etc/localtime:/etc/localtime:ro \
		--name mutt${account} \
		jess/mutt
	)
}

mysql_docker() {
  	drunning
	sudo docker run -d -p 3306:3306 -e MYSQL_PASS=$1 tutum/mysql
	echo "Access mysql with: mysql -h 127.0.0.1 -u admin -p <password>"
}

# terminal audio player w/ mpd
ncmpc(){
	del_stopped ncmpc

	docker run --rm -it \
		-v $HOME/.mpd/socket:/var/run/mpd/socket \
		-e MPD_HOST=/var/run/mpd/socket \
		--name ncmpc \
		jess/ncmpc "$@"
}
nes_docker(){
	del_stopped nes
	local game=$1

	docker run -d \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		--device /dev/dri \
		--device /dev/snd \
		--name nes \
		jess/nes /games/${game}.rom
}
nginx_docker(){
	del_stopped nginx

	docker run -d \
		--restart always \
		-v $HOME/.nginx:/etc/nginx \
		--net host \
		--name nginx \
		nginx

	# add domain to hosts & open nginx
	sudo hostess add jess 127.0.0.1
}

notify_osd(){
	del_stopped notify_osd

	docker run -d \
		-v /etc/machine-id:/etc/machine-id:ro \
		-v /var/run/dbus:/var/run/dbus \
		-v /var/run/user/$(id -u):/var/run/user/$(id -u) \
		-v /etc/localtime:/etc/localtime:ro \
		-e XAUTHORITY \
		-e DBUS_SESSION_BUS_ADDRESS \
		-v /etc/passwd:/etc/passwd:ro \
		-v /etc/group:/etc/group:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-u $(whoami) -w "$HOME" \
		-v $HOME/.Xauthority:$HOME/.Xauthority \
		-v $HOME/.cache/dconf:$HOME/.cache/dconf \
		--name notify_osd \
		jess/notify-osd
}

# file conversion tool
pandoc(){
	local file=${@: -1}
	local lfile=$(readlink -m "$(pwd)/${file}")
	local rfile=$(readlink -m "/$(basename $file)")
	local args=${@:1:${#@}-1}

	docker run --rm \
		-v ${lfile}:${rfile} \
		-v /tmp:/tmp \
		--name pandoc \
		jess/pandoc ${args} ${rfile}
}

# practical music search
pms(){
	del_stopped pms

	docker run --rm -it \
		-v $HOME/.mpd/socket:/var/run/mpd/socket \
		-e MPD_HOST=/var/run/mpd/socket \
		--name pms \
		jess/pms "$@"
}

# secure messaging tool
pond(){
	del_stopped pond
	relies_on torproxy

	docker run --rm -it \
		--net container:torproxy \
		--name pond \
		jess/pond
}
popcorntime_docker() {

	drunning

	dsetup_display
	dsetup_device /dev/snd
	dsetup_device /dev/dri

	sudo docker run -it \
	--net host \
        --memory 512mb \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -e DISPLAY=unix$DISPLAY \
        --device /dev/snd \
        --device /dev/dri \
	jerivas/popcorntime \
        /opt/popcorntime/Popcorn-Time

        #    -e http_proxy=localhost:3128 \
}

# used with skype
pulseaudio(){
	del_stopped pulseaudio

	dsetup_device /dev/snd

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		--device /dev/snd \
		-p 4713:4713 \
		--restart always \
		--name pulseaudio \
		jess/pulseaudio
}

# terminal twitter app
rainbowstream_docker(){
	docker run -it --rm \
		-v /etc/localtime:/etc/localtime:ro \
		-v $HOME/.rainbow_oauth:/root/.rainbow_oauth \
		-v $HOME/.rainbow_config.json:/root/.rainbow_config.json \
		--name rainbowstream \
		jess/rainbowstream
}

# remote desktop tool
remmina_docker(){
	del_stopped remmina

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-v $HOME/.remmina:/root/.remmina \
		--name remmina \
		jess/remmina
}

skype_docker(){
	del_stopped skype
	relies_on pulseaudio

	dsetup_display
	dsetup_device /dev/video0

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		--link pulseaudio:pulseaudio \
		-e PULSE_SERVER=pulseaudio \
		--device /dev/video0 \
		--name skype \
		jess/skype
}

# desktop slack app
slack(){
	del_stopped slack

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		--device /dev/snd \
		--device /dev/dri \
		--group-add audio \
		-v /home/jessie/.slack:/root/.config/Slack \
		--name slack \
		jess/slack

	exit
}
spotify_docker(){
	del_stopped spotify

	dsetup_display

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-e QT_DEVICE_PIXEL_RATIO \
		--device /dev/snd \
		--name spotify \
		jess/spotify
}
steam_docker(){
	del_stopped steam
	relies_on pulseaudio

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /etc/machine-id:/etc/machine-id:ro \
		-v /var/run/dbus:/var/run/dbus \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v $HOME/.steam:/home/steam \
		-e DISPLAY=unix$DISPLAY \
		--link pulseaudio:pulseaudio \
		-e PULSE_SERVER=pulseaudio \
		--device /dev/dri \
		--name steam \
		jess/steam
}

# terminal gameboy emulator
termboy_docker(){
	del_stopped termboy
	local game=$1

	docker run --rm -it \
		--device /dev/snd \
		--name termboy \
		jess/nes /games/${game}.rom
}
tor_docker(){
	del_stopped tor

	docker run -d \
		--net host \
		--name tor \
		jess/tor

	# set up the redirect iptables rules
	sudo setup-tor-iptables

	# validate we are running through tor
	browser-exec "https://check.torproject.org/"
}
torbrowser_docker(){
	del_stopped torbrowser

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--device /dev/snd \
		--name torbrowser \
		jess/tor-browser

	# exit current shell
	exit 0
}
tormessenger_docker(){
	del_stopped tormessenger

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--device /dev/snd \
		--name tormessenger \
		jess/tor-messenger

	# exit current shell
	exit 0
}
torproxy_docker(){
	del_stopped torproxy

	docker run -d \
		--restart always \
		-v /etc/localtime:/etc/localtime:ro \
		-p 9050:9050 \
		--name torproxy \
		jess/tor-proxy

	sudo hostess add torproxy $(docker inspect --format "{{.NetworkSettings.Networks.bridge.IPAddress}}" torproxy)
}

# torrent application
transmission_docker(){
	del_stopped transmission

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v $HOME/Torrents:/transmission/download \
		-v $HOME/.transmission:/transmission/config \
		-p 9091:9091 \
		-p 51413:51413 \
		-p 51413:51413/udp \
		--name transmission \
		jess/transmission
}

vagrant_docker(){
	del_stopped vagrant

	# modprobe the module
	sudo modprobe vboxdrv

	docker run -it \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix  \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--name vagrant \
		--net host \
		-v "$HOME/.vbox/vms:/root/VirtualBox VMs" \
		-v $HOME/.vbox/config:/root/.config/VirtualBox \
		-v $HOME/oscon:/root/oscon \
		--privileged \
		--entrypoint bash \
		jess/vagrant
}

virtualbox_docker(){
	del_stopped virtualbox

	# modprobe the module
	sudo modprobe vboxdrv
	# and the extras for networking
	sudo insmod /lib/modules/$(uname -r)/misc/vboxnet*.ko

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix  \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--name virtualbox \
		--net host \
		-v "$HOME/.vbox/vms:/root/VirtualBox VMs" \
		-v $HOME/.vbox/config:/root/.config/VirtualBox \
		--privileged \
		jess/virtualbox
}
visualstudio_docker(){
	del_stopped visualstudio

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix  \
		-e DISPLAY=unix$DISPLAY \
		--name visualstudio \
		jess/visualstudio
}
vlc_docker(){
	del_stopped vlc
	relies_on pulseaudio

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-e QT_DEVICE_PIXEL_RATIO \
		--link pulseaudio:pulseaudio \
		-e PULSE_SERVER=pulseaudio \
		-v $HOME/Torrents:/home/vlc/Torrents \
		--device /dev/dri \
		--name vlc \
		jess/vlc
}
# monitors files and performs actions when they change
watchman_docker(){
	del_stopped watchman

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v $HOME/Downloads:/root/Downloads \
		--name watchman \
		jess/watchman --foreground
}

# modern http benchmarking
wrk_docker(){
	docker run -it --rm \
		--log-driver none \
		--name wrk \
		jess/wrk "$@"
}

###
### Awesome sauce by @jpetazzo
###
command_not_found_handle () {
	# Check if there is a container image with that name
	if ! docker inspect --format '{{ .Author }}' "$1" >&/dev/null ; then
		echo "$0: $1: command not found"
		return
	fi

	# Check that it's really the name of the image, not a prefix
	if docker inspect --format '{{ .Id }}' "$1" | grep -q "^$1" ; then
		echo "$0: $1: command not found"
		return
	fi

	docker run -ti -u $(whoami) -w "$HOME" \
		$(env | cut -d= -f1 | awk '{print "-e", $1}') \
		--device /dev/snd \
		-v /etc/passwd:/etc/passwd:ro \
		-v /etc/group:/etc/group:ro \
		-v /etc/localtime:/etc/localtime:ro \
		-v /home:/home \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		"jess/$@"
}
